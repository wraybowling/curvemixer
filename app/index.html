<!doctype html>
<html>
<head>
<title>CurveMixer</title>
<script src="uservoice.js"></script>
<style>
	body{
		margin:0;
		cursor:crosshair;
		font-family:Helvetica Neue;
	}

	svg{
		position:absolute;
	}

	.stage{
		background-color:#cbfffb;
	}

	.interface .selection-line{
		stroke-width:2px;
		stroke:red;
	}

	.final_stage{
		fill:none;
		stroke-width:15;
		stroke:#ff6b20;
	}

	.interface circle{
		fill:black;
	}

	svg *{
		fill:black;
	}

	.cheatsheet{
		position:fixed;
		padding:10px;
	}
</style>
</head>
<body>
	<div class="mixablz">
		<svg class="stage">
			<path class="final_stage" />
		</svg>
		<svg class="interface">
			<path class="selection-line" />
			<g class="anchors"></g>
		</svg>
	</div>
	<div class="cheatsheet">
		Commands:
		<br>[M]ove 1 ~
		[L]ine 1 ~
		[H]orizontal 1 ~
		[V]ertical 1 ~
		[C]astel3 3 ~
		[S]Castel3-locked 2 ~
		[Q]uadratic 2 ~
		[T]Quadratic-locked 1 ~
		[A]rc 1r2s1 ~
		Clo[Z]e
		<br>[G]rab
	</div>
</body>

<script>

	// GLOBALS
	function distance(Xa,Ya,Xb,Yb){
		return Math.sqrt(Math.pow((Xb - Xa),2) + Math.pow((Yb - Ya),2));
	}

	// XML CLASS
	XML = function(name){
		var namespace = 'http://www.w3.org/2000/svg';
		this.element = document.createElementNS(namespace,name);
	};

	XML.prototype.attr = function(name,value){
		this.element.setAttributeNS(null,name,value);
	};

	// MASTER CLASS
	CURVEMIXER = function(element){
		// storage
		this.container = element;
		this.interface = element.querySelector('.interface');
		this.stage = element.querySelector('.stage');
		this.mode = null;
		this.paths = [];
		this.anchors = [];
		this.closed = false;
		this.closest_anchor_index = 0;
		this.selected_anchor_type = null;
		this.selected_anchor_index = null;
		this.prevX = 0;
		this.prevY = 0;
		// Attach DOM Listeners
		this.container.onmousemove = this.mousemove;
		this.container.onmousedown = this.mousedown;
		this.container.onmouseup = this.mouseup;
		this.container.onmousewheel = this.mousewheel;
		window.addEventListener("keydown", this.keydown);
		window.addEventListener("keyup", this.keyup);
	};

	// Render
	CURVEMIXER.prototype.renderInterface = function() {
		console.log('Building interface');
		var i;

		current_circles = this.interface.querySelectorAll('circle');
		for(i=0; i<current_circles.length; i++){
			current_circles[i].remove();
		}

		for(i=0; i<this.anchors.length; i++){
			var doop = new XML('circle');
			doop.attr('cx',this.anchors[i].coordinates.x);
			doop.attr('cy',this.anchors[i].coordinates.y);
			doop.attr('r',3);
			this.interface.appendChild(doop.element);
		}
	};

	CURVEMIXER.prototype.renderPaths = function() {
		console.log('Building paths');
		var i;

		var final_path = this.stage.querySelector('.final_stage');

		data = [];
		for(i=0; i<this.anchors.length; i++){
			if(i===0) this.anchors[i].type = 'M';
			if(!!this.anchors[i].type) data.push(this.anchors[i].type);
			switch(this.anchors[i].type){
				case 'H':
					data.push(this.anchors[i].coordinates.x);
					break;
				case 'V':
					data.push(this.anchors[i].coordinates.y);
					break;
				default:
					data.push(this.anchors[i].coordinates.x+','+this.anchors[i].coordinates.y);
			}
		}
		if(this.closed){
			data.push('z');
		}

		final_path.setAttributeNS(null,'d',data.join(' '));

/*
		var path_index = 0;
		var anchor_index = 0;
		for(; path_index<this.paths.length; path_index++){
			var doop = new XML('circle');
			for(var i=0; i<this.paths[path_index].anchor_count; i++){
				var doop = new XML('circle');
				doop.attr('cx',this.anchors[i].coordinates.x);
				doop.attr('cy',this.anchors[i].coordinates.y);
				doop.attr('r',3);
				this.interface.appendChild(doop.element);
			}
		}
*/
	};

	// Event functions
	CURVEMIXER.prototype.mousemove = function(event){


		// move selected anchor
		if(mixer.mode == 'move'){
			console.log(event);
			mixer.anchors[mixer.selected_anchor_index].coordinates.x += event.x - mixer.prevX;
			mixer.anchors[mixer.selected_anchor_index].coordinates.y += event.y - mixer.prevY;
			mixer.renderInterface();
			mixer.renderPaths();
		}

//		console.log('move',event);
		//RenderInterface();

		// determine closest anchor
		mixer.closest_anchor_distance = 9999;
		mixer.closest_anchor_index = 0;

//		console.group('distance');
		for(var i=0; i<mixer.anchors.length; i++){
			var anchor = mixer.anchors[i];

			var new_distance = distance(anchor.coordinates.x, anchor.coordinates.y, event.x, event.y);

			if(new_distance < mixer.closest_anchor_distance ){
				mixer.closest_anchor_distance = new_distance;
				mixer.closest_anchor_index = i;
//				console.log('shorter',distance(anchor.coordinates.x, anchor.coordinates.y, event.x, event.y));
			}else{
//				console.log('longer');
			}
		}
//		console.groupEnd();

		result = ['M'];
		result.push(event.x + ',' + event.y);
		result.push('L' + mixer.anchors[mixer.closest_anchor_index].coordinates.x + ',' + mixer.anchors[mixer.closest_anchor_index].coordinates.y);
		var d = result.join(' ');

		mixer.interface.querySelector('.selection-line').setAttributeNS(null,'d',d);

		// set previous to current
		mixer.prevX = event.x;
		mixer.prevY = event.y;
	};

	CURVEMIXER.prototype.mousedown = function(event){
		console.log('down',event);
	};

	CURVEMIXER.prototype.mouseup = function(event){
		console.log('up',event);
//		this.RenderInterface();
		var new_anchor = new ANCHOR('M',event);
		console.log(new_anchor);
		mixer.anchors.push(new_anchor);
		mixer.renderInterface();
		mixer.renderPaths();
	};

	CURVEMIXER.prototype.mousewheel = function(event){
		event.preventDefault();
		console.log('wheel',event);
	};

	CURVEMIXER.prototype.keydown = function(event){
		event.preventDefault();
//		console.log('key dn',event.keyCode,event);
		switch(event.keyCode){
			case 76:mixer.selected_anchor_type = 'L'; break;
			case 72:mixer.selected_anchor_type = 'H'; break;
			case 86:mixer.selected_anchor_type = 'V'; break;
			case 67:mixer.selected_anchor_type = 'C'; break;
			case 83:mixer.selected_anchor_type = 'S'; break;
			case 81:mixer.selected_anchor_type = 'Q'; break;
			case 84:mixer.selected_anchor_type = 'T'; break;
			case 65:mixer.selected_anchor_type = 'A'; break;

			case 90: // Z
				mixer.closed = !mixer.closed;
				mixer.renderPaths();
				break;

			case 71: // G
				mixer.mode = 'move';
				mixer.selected_anchor_index = mixer.closest_anchor_index;
		}
		console.log('anchor type',mixer.selected_anchor_type);
		console.log('mode',mixer.mode);
	};

	CURVEMIXER.prototype.keyup = function(event){
		event.preventDefault();
		switch(event.keyCode){
			case 71:
				mixer.mode = null;
				mixer.selected_anchor_index = null;
		}
//		console.log('key up',event.keyCode,event);
	};

	// PATH CLASS
	PATH = function(){
		this.anchor_count = 0;
		this.classes = [];
	};

	PATH.prototype.addClass = function(name){
		this.classes.push(name);
	};

	// ANCHOR CLASS
	ANCHOR = function(type,coordinates){
		var types = ['spiro-4','levein-4'];
		this.type = mixer.selected_anchor_type;
		if(!!mixer.selected_anchor_type) mixer.selected_anchor_type = null;
		this.coordinates = {
			x: coordinates.x
			,y: coordinates.y
		};
	};

	ANCHOR.prototype.setCoordinates = function(coordinates){
		this.coordinates.x = coordinates.x;
		this.coordinates.y = coordinates.y;
	};

	//////////

	mixer = new CURVEMIXER(document.querySelector('.mixablz'));
	mixer.paths.push( new PATH() );

</script>

</html>