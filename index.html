<!doctype html>
<html>
<head>
<style>
	body{
		margin:0;
		cursor:crosshair;
	}

	svg{
		position:absolute;
	}

	.stage{
		background-color: skyblue;
	}

	.interface .selection-line{
		stroke-width:2px;
		stroke:red;
	}

	svg *{
		fill:black;
	}
</style>
</head>
<body>
	<div class="mixablz">
		<svg class="stage">
			<path class="final_stage" />
		</svg>
		<svg class="interface">
			<path class="selection-line" />
			<g class="anchors"></g>
		</svg>
	</div>
</body>

<script>

	// GLOBALS
	function distance(Xa,Ya,Xb,Yb){
		return Math.sqrt(Math.pow((Xb - Xa),2) + Math.pow((Yb - Ya),2));
	}

	// XML CLASS
	XML = function(name){
		var namespace = 'http://www.w3.org/2000/svg';
		this.element = document.createElementNS(namespace,name);
	};

	XML.prototype.attr = function(name,value){
		this.element.setAttributeNS(null,name,value);
	};

	// MASTER CLASS
	CURVEMIXER = function(element){
		// storage
		this.container = element;
		this.interface = element.querySelector('.interface');
		this.stage = element.querySelector('.stage');
		this.paths = [];
		this.anchors = [];
		this.closest_anchor_index = 0;
		// Attach DOM Listeners
		this.container.onmousemove = this.mousemove;
		this.container.onmousedown = this.mousedown;
		this.container.onmouseup = this.mouseup;
		this.container.onmousewheel = this.mousewheel;
		this.container.addEventListener("keydown", this.keydown);
		this.container.addEventListener("keyup", this.keyup);
		this.container.addEventListener("keypress", this.keypress);
	};

	// Render
	CURVEMIXER.prototype.renderInterface = function() {
		console.log('Building interface');

		for(var i=0; i<this.anchors.length; i++){
			var doop = new XML('circle');
			doop.attr('cx',this.anchors[i].coordinates.x);
			doop.attr('cy',this.anchors[i].coordinates.y);
			doop.attr('r',3);
			this.interface.appendChild(doop.element);
		}
	};

	// Event functions
	CURVEMIXER.prototype.mousemove = function(event){
//		console.log('move',event);
		//RenderInterface();

		// determine closest anchor
		mixer.closest_anchor_distance = 9999;
		mixer.closest_anchor_index = 0;

		console.group('distance');
		for(var i=0; i<mixer.anchors.length; i++){
			var anchor = mixer.anchors[i];

			var new_distance = distance(anchor.coordinates.x, anchor.coordinates.y, event.x, event.y);

			if(new_distance < mixer.closest_anchor_distance ){
				mixer.closest_anchor_distance = new_distance;
				mixer.closest_anchor_index = i;
				console.log('shorter',distance(anchor.coordinates.x, anchor.coordinates.y, event.x, event.y));
			}else{
				console.log('longer');
			}

		}
		console.groupEnd();

		result = ['M'];
		result.push(event.x + ',' + event.y);
		result.push('L' + mixer.anchors[mixer.closest_anchor_index].coordinates.x + ',' + mixer.anchors[mixer.closest_anchor_index].coordinates.y);
		var d = result.join(' ');

		mixer.interface.querySelector('.selection-line').setAttributeNS(null,'d',d);
		
	};

	CURVEMIXER.prototype.mousedown = function(event){
		console.log('down',event);
//		this.RenderInterface();
	};

	CURVEMIXER.prototype.mouseup = function(event){
		console.log('up',event);
//		this.RenderInterface();
		var new_anchor = new ANCHOR('M',event);
		console.log(new_anchor);
		mixer.anchors.push(new_anchor);
		mixer.renderInterface();
	};

	CURVEMIXER.prototype.mousewheel = function(event){
		event.preventDefault();
//		console.log('wheel',event);
//		this.RenderInterface();
	};

	CURVEMIXER.prototype.keydown = function(event){
//		console.log('key dn',event.keyCode,event);
//		this.RenderInterface();
	};

	CURVEMIXER.prototype.keyup = function(event){
//		console.log('key up',event.keyCode,event);
//		this.RenderInterface();
	};

	CURVEMIXER.prototype.keypress = function(event){
//		console.log('key press',event.keyCode,event);
//		this.RenderInterface();
	};

	// PATH CLASS
	PATH = function(){
		this.anchor_count = 0;
		this.classes = [];
	};

	PATH.prototype.addClass = function(name){
		this.classes.push(name);
	};

	// ANCHOR CLASS
	ANCHOR = function(type,coordinates){
		var types = ['spiro-4','levein-4'];
		this.type = type;
		this.coordinates = {
			x: coordinates.x
			,y: coordinates.y
		};
	};

	ANCHOR.prototype.setCoordinates = function(coordinates){
		this.coordinates.x = coordinates.x;
		this.coordinates.y = coordinates.y;
	};

	//////////

	mixer = new CURVEMIXER(document.querySelector('.mixablz'));
	mixer.paths.push( new PATH() );

</script>

</html>